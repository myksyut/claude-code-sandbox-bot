---
name: technical-spec
description: 環境変数、アーキテクチャ設計、ビルド・テストコマンドを定義。環境設定、アーキテクチャ設計時に使用。
---

# 技術設計ルール

## 技術スタックの基本方針
Pythonをベースとしたアプリケーション実装。アーキテクチャパターンはプロジェクトの要件と規模に応じて選択すること。

## プロジェクト固有の技術スタック

### コア技術
| レイヤー | 技術 | 用途 |
|---------|------|------|
| 言語 | Python 3.12+ | アプリケーション全体 |
| Slack連携 | Slack Bolt (Python) | Bot実装、Socket Mode対応 |
| AI実行環境 | Claude Code CLI | サンドボックス内でのコード実行 |
| MCP統合 | Model Context Protocol | 外部ツール連携 |

### インフラストラクチャ（Azure）- 分離構成
| サービス | 用途 | 備考 |
|---------|------|------|
| Azure Container Apps | Slack Bot常駐プロセス | Socket Mode接続、タスク管理 |
| Azure Container Instances (ACI) | サンドボックス実行 | リクエストごと起動・即破棄、秒単位課金 |
| Azure Cache for Redis | 中間状態管理、セッション管理 | 揮発性OK、高速I/O |
| Azure Container Registry | コンテナイメージ管理 | サンドボックスイメージ格納 |
| Azure Key Vault | シークレット管理 | APIキー、トークン保管 |

### 主要ライブラリ
```
# Slack連携
slack-bolt>=1.18.0
slack-sdk>=3.27.0

# 非同期処理
aiohttp>=3.9.0

# データ永続化
redis>=5.0.0

# 設定管理
pydantic>=2.0.0
pydantic-settings>=2.0.0

# Claude Code連携
anthropic>=0.30.0  # API直接利用時
```

### アーキテクチャ概要（分離構成）
```
┌─────────────┐     ┌──────────────────────────────────────────┐
│   Slack     │◀───▶│  Slack Bot (Container Apps) - 常駐       │
│  (User)     │     │  - Socket Mode接続                       │
└─────────────┘     │  - タスクキュー管理 / 進捗通知            │
                    │  - AskUserQuestion の回答リダイレクト     │
                    └──────────────────────────────────────────┘
                                        │
                        ┌───────────────┴───────────────┐
                        ▼                               ▼
                ┌──────────────┐               ┌───────────────┐
                │    Redis     │               │     ACI       │
                │ (State/Queue)│               │  (Sandbox)    │
                └──────────────┘               └───────────────┘
                                                       │
                                                       ▼
                                               ┌───────────────┐
                                               │ Claude Code   │
                                               │ CLI + Hooks   │
                                               └───────────────┘
                                                       │
                                                       ▼
                                               ┌───────────────┐
                                               │ GitHub Repo   │
                                               │   (Clone)     │
                                               └───────────────┘
```

### リトライ・状態管理設計
- **冪等性キー**: 各リクエストにUUIDを付与し、重複実行を防止
- **中間状態管理**: 処理ステップごとにRedisへ状態を保存（揮発性OK）
- **失敗時の再実行**: 同一リクエストを再送信することで再試行可能

### Human-in-the-loop 設計
Claude Codeがユーザーに確認を求める場合のフロー（スクリプト + Skills方式）：

```
┌─────────────────────────────────────────────────────────────┐
│  Claude Code (--dangerously-skip-permissions)              │
│  Skills/CLAUDE.md: 「質問時は ask_user.py を使用」           │
│                        ↓                                    │
│  Bash: python /tools/ask_user.py "質問内容"                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  ask_user.py（サンドボックス内スクリプト）                   │
│  1. Redis経由でSlack Botに質問を送信                        │
│  2. Redis subでユーザー回答を待機                           │
│  3. 回答を標準出力に出力 → Claude Codeが受け取る            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  Slack Bot                                                  │
│  → ユーザーに質問を転送（スレッド内）                        │
│  → ユーザーの回答をRedis経由でスクリプトに返す               │
└─────────────────────────────────────────────────────────────┘
```

- **実行モード**: `--dangerously-skip-permissions`（ファイル操作等は自動承認）
- **ask_user.py**: サンドボックス内に配置するシンプルなPythonスクリプト
- **通信**: Redis pub/sub（Slack Botと双方向通信）
- **タイムアウト**: 設定可能（デフォルト10分）、超過時は中断または続行を選択可能
- **Bashタイムアウト延長**: サンドボックス内の `~/.claude/settings.json` で設定
  ```json
  {"env": {"BASH_DEFAULT_TIMEOUT_MS": "600000", "BASH_MAX_TIMEOUT_MS": "900000"}}
  ```

### スケーリング方針
- **方式**: 制限付き並列実行
- **同時実行数上限**: 環境変数 `MAX_CONCURRENT_TASKS` で設定（デフォルト: 3）
- **超過時**: キューイングして順次実行
- **進捗通知**: スレッド更新式（最初のメッセージを編集して進捗表示）

### サンドボックスのライフサイクル
- **作成**: リクエストごとに新規ACIコンテナを起動
- **破棄**: タスク完了後即座に破棄
- **リポジトリ**: 都度クローン（キャッシュなし）
- **設計思想**: ステートレス（毎回クリーンな状態で実行）

### 外部連携設定
| 項目 | 設定 |
|------|------|
| Slack接続 | Socket Mode（WebSocket、外部URL不要） |
| GitHub認証 | Personal Access Token |
| 認可範囲 | Workspace全員利用可（制限なし） |

### サンドボックス ↔ Slack Bot 通信
- **方式**: Redis pub/sub
- **理由**: 双方向通信に適する、既にRedisを使用、疎結合

### タスク結果の返却
- **短文（4000文字以下）**: Slackにそのまま投稿
- **長文（4000文字超）**: テキストファイルとしてSlackにアップロード

### ACI起動時間への対応
- **方針**: 30秒〜1分の起動時間は許容
- **UX対策**: リクエスト受信後、即座に「起動中...」をSlackに投稿

## 環境変数管理とセキュリティ

### 環境変数管理
- 環境変数は一元管理し、型安全性を確保する仕組みを構築すること
- `os.environ` の直接参照は避け、設定管理層（pydantic-settings等）を通じて取得すること
- デフォルト値の設定や必須チェックを適切に実装すること

### セキュリティ
- `.env`ファイルはGitに含めない
- APIキーやシークレットは必ず環境変数として管理
- 機密情報のログ出力は禁止
- エラーメッセージに機密情報を含めない

## アーキテクチャ設計

### アーキテクチャ設計の原則
プロジェクトごとに適切なアーキテクチャを選択し、明確に定義すること：

- **責務の分離**: 各層やモジュールの責務を明確に定義し、境界を守ること

## データフロー統一原則

#### 基本原則
1. **単一データソース**: 同じ情報は1箇所にのみ保存する
2. **構造化データ優先**: JSON文字列ではなくパース済みオブジェクトを使用
3. **明確な責務分離**: 各層の責務を明確に定義

#### データフローのベストプラクティス
- **入力時点での検証**: データは入力層で検証し、型安全な形で内部に渡す
- **変換の一元化**: データ変換ロジックは専用のユーティリティに集約
- **ログの構造化**: データフローの各段階で構造化ログを出力

## ビルドとテスト
pyproject.tomlの設定に応じた実行コマンドを使用すること。

### 開発コマンド
- `uv run python src/main.py` - アプリケーション実行
- `uv run ruff check src` - リントチェック
- `uv run ruff format src` - フォーマット

### テストコマンド
- `uv run pytest` - テスト実行
- `uv run pytest --cov=src` - カバレッジ測定
- `uv run pytest --cov=src --cov-report=html` - HTMLレポート生成

### 品質チェック要件

品質チェックは実装完了時に必須：

**Phase 1-3: コード品質チェック**
- `uv run ruff check src` - リントチェック
- `uv run ruff format --check src` - フォーマットチェック
- `uv run ty check src` - 型チェック（tyが安定版になり次第）

**Phase 4: テスト**
- `uv run pytest` - テスト実行

**Phase 5: コード品質再検証**
- `uv run ruff check src tests` - コード品質の再検証

### 補助コマンド
- `uv run ruff check --fix src` - Lint修正
- `uv run ruff format src` - フォーマット修正
- `open coverage/html/index.html` - カバレッジレポート確認

### トラブルシューティング
- **依存関係エラー**: `uv sync --dev` を実行
- **キャッシュ問題**: `.pytest_cache/` と `__pycache__/` を削除

### カバレッジ要件
- **必須**: ユニットテストカバレッジは70%以上
- **メトリクス**: Statements、Branches、Functions
