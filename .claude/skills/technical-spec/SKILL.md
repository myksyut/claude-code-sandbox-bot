---
name: technical-spec
description: 環境変数、アーキテクチャ設計、ビルド・テストコマンドを定義。環境設定、アーキテクチャ設計時に使用。
---

# 技術設計ルール

## 技術スタックの基本方針
Pythonをベースとしたアプリケーション実装。アーキテクチャパターンはプロジェクトの要件と規模に応じて選択すること。

## 環境変数管理とセキュリティ

### 環境変数管理
- 環境変数は一元管理し、型安全性を確保する仕組みを構築すること
- `os.environ` の直接参照は避け、設定管理層（pydantic-settings等）を通じて取得すること
- デフォルト値の設定や必須チェックを適切に実装すること

### セキュリティ
- `.env`ファイルはGitに含めない
- APIキーやシークレットは必ず環境変数として管理
- 機密情報のログ出力は禁止
- エラーメッセージに機密情報を含めない

## アーキテクチャ設計

### アーキテクチャ設計の原則
プロジェクトごとに適切なアーキテクチャを選択し、明確に定義すること：

- **責務の分離**: 各層やモジュールの責務を明確に定義し、境界を守ること

## データフロー統一原則

#### 基本原則
1. **単一データソース**: 同じ情報は1箇所にのみ保存する
2. **構造化データ優先**: JSON文字列ではなくパース済みオブジェクトを使用
3. **明確な責務分離**: 各層の責務を明確に定義

#### データフローのベストプラクティス
- **入力時点での検証**: データは入力層で検証し、型安全な形で内部に渡す
- **変換の一元化**: データ変換ロジックは専用のユーティリティに集約
- **ログの構造化**: データフローの各段階で構造化ログを出力

## ビルドとテスト
pyproject.tomlの設定に応じた実行コマンドを使用すること。

### 開発コマンド
- `uv run python src/main.py` - アプリケーション実行
- `uv run ruff check src` - リントチェック
- `uv run ruff format src` - フォーマット

### テストコマンド
- `uv run pytest` - テスト実行
- `uv run pytest --cov=src` - カバレッジ測定
- `uv run pytest --cov=src --cov-report=html` - HTMLレポート生成

### 品質チェック要件

品質チェックは実装完了時に必須：

**Phase 1-3: コード品質チェック**
- `uv run ruff check src` - リントチェック
- `uv run ruff format --check src` - フォーマットチェック
- `uv run ty check src` - 型チェック（tyが安定版になり次第）

**Phase 4: テスト**
- `uv run pytest` - テスト実行

**Phase 5: コード品質再検証**
- `uv run ruff check src tests` - コード品質の再検証

### 補助コマンド
- `uv run ruff check --fix src` - Lint修正
- `uv run ruff format src` - フォーマット修正
- `open coverage/html/index.html` - カバレッジレポート確認

### トラブルシューティング
- **依存関係エラー**: `uv sync --dev` を実行
- **キャッシュ問題**: `.pytest_cache/` と `__pycache__/` を削除

### カバレッジ要件
- **必須**: ユニットテストカバレッジは70%以上
- **メトリクス**: Statements、Branches、Functions
